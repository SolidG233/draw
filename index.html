<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>æé€Ÿä½ ç”»æˆ‘çŒœ (ç¨³å®šè¿æ¥ç‰ˆ)</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/peerjs/1.5.2/peerjs.min.js"></script>
    <style>
        * { box-sizing: border-box; }
        body { font-family: 'Segoe UI', sans-serif; background: #f0f2f5; display: flex; flex-direction: column; align-items: center; padding: 10px; margin: 0; height: 100vh; overflow: hidden; }
        
        /* é¡¶éƒ¨ */
        header { width: 100%; max-width: 1000px; background: #fff; padding: 10px 15px; border-radius: 8px; box-shadow: 0 2px 5px rgba(0,0,0,0.05); margin-bottom: 10px; display: flex; justify-content: space-between; align-items: center; flex-shrink: 0; }
        h1 { margin: 0; font-size: 18px; color: #333; display: flex; align-items: center; gap: 5px; }
        .tag { font-size: 10px; background: #dc3545; color: white; padding: 2px 4px; border-radius: 3px; }
        
        /* æ¸¸æˆæ ¸å¿ƒåŒº */
        #game-container { display: flex; gap: 10px; width: 100%; max-width: 1000px; flex: 1; overflow: hidden; }
        
        /* å·¦ä¾§ç”»æ¿åŒº */
        #left-panel { flex: 2; display: flex; flex-direction: column; gap: 10px; position: relative; min-width: 0; }
        
        #canvas-wrapper { position: relative; flex: 1; background: #fff; border: 2px solid #333; border-radius: 4px; display: flex; justify-content: center; align-items: center; overflow: hidden; touch-action: none; }
        canvas { display: block; touch-action: none; cursor: crosshair; }
        
        /* ç”»å»Šè§†å›¾ */
        #gallery-view { 
            display: none; flex: 1; background: #fff; border-radius: 4px; padding: 10px; 
            flex-wrap: wrap; gap: 10px; justify-content: center; overflow-y: auto; align-content: flex-start;
        }
        .gallery-item { width: 30%; height: 120px; border: 1px solid #ccc; position: relative; display: flex; flex-direction: column; background: #eee; }
        .gallery-item img { width: 100%; height: 100%; object-fit: contain; background: white; }
        .gallery-item .label { position: absolute; top: 0; left: 0; background: #007bff; color: white; padding: 2px 6px; font-size: 12px; }
        .gallery-item .answer { background: #28a745; color: white; text-align: center; font-weight: bold; padding: 5px; display: none; font-size: 12px; }
        .gallery-item.solved .answer { display: block; }
        .gallery-item.solved { border: 2px solid #28a745; }

        /* é®ç½©ä¸æç¤º */
        #blocker { position: absolute; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.1); z-index: 10; display: none; cursor: not-allowed; }
        
        #status-overlay { 
            position: absolute; top: 20px; left: 50%; transform: translateX(-50%); 
            background: rgba(0,0,0,0.8); color: white; padding: 10px 20px; 
            border-radius: 30px; font-size: 18px; font-weight: bold; pointer-events: none; z-index: 20; text-align: center;
            min-width: 180px; white-space: nowrap;
        }
        #timer-display { font-size: 32px; color: #ffeb3b; display: block; margin-top: 5px; font-weight: 900; }

        /* å³ä¾§èŠå¤© */
        #right-panel { flex: 1; display: flex; flex-direction: column; gap: 10px; min-width: 250px; }
        #player-list { background: #fff; padding: 8px; border-radius: 8px; max-height: 150px; overflow-y: auto; font-size: 13px; }
        .p-card { padding: 4px; border-bottom: 1px solid #eee; display: flex; justify-content: space-between; align-items: center; }
        .role-badge { font-weight: bold; padding: 1px 4px; border-radius: 3px; font-size: 11px; }
        .role-P1 { background: #ffeeba; color: #856404; }
        .role-P2 { background: #d4edda; color: #155724; }
        .role-P3 { background: #cce5ff; color: #004085; }
        .role-OBS { background: #e2e3e5; color: #383d41; }

        #chat-box { flex: 1; background: #fff; border-radius: 8px; display: flex; flex-direction: column; overflow: hidden; }
        #messages { flex: 1; overflow-y: auto; padding: 10px; background: #f9f9f9; }
        .msg { margin-bottom: 6px; font-size: 13px; word-break: break-all; }
        .msg.sys { color: #888; text-align: center; font-style: italic; margin: 8px 0; font-size: 12px; }
        .msg.win { background: #d4edda; color: #155724; padding: 5px; text-align: center; border-radius: 4px; font-weight: bold; }
        
        #input-area { padding: 8px; display: flex; gap: 5px; border-top: 1px solid #eee; }
        input[type=text] { flex: 1; padding: 8px; border: 1px solid #ddd; border-radius: 4px; outline: none; }
        button { padding: 8px 12px; background: #007bff; color: white; border: none; border-radius: 4px; cursor: pointer; white-space: nowrap; }
        button:hover { background: #0056b3; }
        button:disabled { background: #ccc; cursor: not-allowed; }

        /* è¿æ¥é¢æ¿ */
        #conn-panel { background: #fff; padding: 15px; border-radius: 8px; margin-bottom: 10px; width: 100%; max-width: 600px; box-shadow: 0 4px 12px rgba(0,0,0,0.1); }
        .conn-row { display: flex; gap: 10px; align-items: center; margin-bottom: 10px; flex-wrap: wrap; }
        .conn-divider { width: 100%; height: 1px; background: #eee; margin: 10px 0; }

        /* æˆ¿ä¸»å‡ºé¢˜å¼¹çª— */
        #host-input-modal { 
            position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); 
            z-index: 100; display: none; justify-content: center; align-items: center; 
        }
        .modal-content { background: white; padding: 20px; border-radius: 8px; width: 300px; box-shadow: 0 5px 15px rgba(0,0,0,0.2); }
        .modal-content input { width: 100%; margin-bottom: 10px; box-sizing: border-box; }
        
        select { padding: 8px; border-radius: 4px; border: 1px solid #ddd; }

        /* ç§»åŠ¨ç«¯é€‚é… */
        @media (max-width: 768px) {
            #game-container { flex-direction: column; }
            #left-panel { flex: 1; height: 50vh; }
            #right-panel { flex: 1; height: 40vh; min-width: 0; }
            #canvas-wrapper { min-height: 250px; }
            .gallery-item { width: 45%; }
        }
    </style>
</head>
<body>

<header>
    <div>
        <h1>âš¡ æé€Ÿè¿ç”» <span class="tag">åœ°ç‹±ç‰ˆ</span></h1>
        <div style="font-size:12px; color:#666; margin-top:2px;">è§„åˆ™: P2è¿ç»­ç”»5å¼ (æ¯å¼ 2ç§’)ï¼Œæœ€åP3æŠ¢ç­”</div>
    </div>
    <div id="my-role-display" style="font-size:14px;">ğŸ”´ æœªè¿æ¥</div>
</header>

<div id="conn-panel">
    <!-- ç¬¬ä¸€è¡Œï¼šé€šç”¨è®¾ç½® -->
    <div class="conn-row">
        <label>æˆ‘çš„æ˜µç§°:</label> 
        <input type="text" id="nickname" value="ç©å®¶1" style="width:100px">
        <select id="role-select">
            <option value="P2">æˆ‘æƒ³å½“: ç”»æ‰‹ (P2)</option>
            <option value="P3" selected>æˆ‘æƒ³å½“: çŒœé¢˜ (P3)</option>
            <option value="OBS">ä»…å›´è§‚</option>
        </select>
    </div>

    <div class="conn-divider"></div>

    <!-- ç¬¬äºŒè¡Œï¼šåˆ›å»ºæˆ–åŠ å…¥ -->
    <div id="setup-box">
        <div class="conn-row" style="justify-content: space-between;">
            <div style="flex:1; display:flex; gap:5px; align-items:center;">
                <label>æˆ¿é—´å·:</label>
                <input type="text" id="room-id-input" placeholder="ä¾‹å¦‚: 888" style="width:100px; font-weight:bold;">
                <span style="font-size:12px; color:#888;">(æ•°å­—/å­—æ¯)</span>
            </div>
        </div>
        <div class="conn-row" style="margin-top:15px; justify-content: center; gap: 20px;">
            <button onclick="createRoom()" style="background:#28a745; padding: 10px 20px; font-size:16px;">æˆ‘æ˜¯æˆ¿ä¸» (åˆ›å»º)</button>
            <button onclick="joinRoom()" style="background:#007bff; padding: 10px 20px; font-size:16px;">åŠ å…¥æˆ¿é—´</button>
        </div>
    </div>
    
    <!-- çŠ¶æ€æ˜¾ç¤º -->
    <div id="connection-status" style="margin-top:10px; text-align:center; font-size:14px; color:#666;"></div>
</div>

<div id="game-container">
    <div id="left-panel">
        <!-- ç”»å¸ƒæ¨¡å¼ -->
        <div id="canvas-wrapper">
            <canvas id="canvas"></canvas>
            <div id="blocker"></div>
            <div id="status-overlay" style="display:none;">
                <div id="overlay-text">ç­‰å¾…å¼€å§‹</div>
                <div id="timer-display"></div>
            </div>
        </div>
        <!-- ç”»å»Šæ¨¡å¼ (æœ€åæ˜¾ç¤º) -->
        <div id="gallery-view"></div>

        <div style="display:flex; gap:10px; justify-content:center; margin-top:5px;">
            <button onclick="clearCanvas()" id="btn-clear" disabled>æ¸…ç©ºç”»æ¿</button>
        </div>
    </div>

    <div id="right-panel">
        <div id="player-list">
            <div style="font-weight:bold; margin-bottom:5px; border-bottom:1px solid #eee;">ç©å®¶åˆ—è¡¨:</div>
            <div id="p-list-content">ç­‰å¾…åŠ å…¥...</div>
        </div>
        <div id="chat-box">
            <div id="messages"></div>
            <div id="input-area">
                <input type="text" id="msg-input" placeholder="è¾“å…¥çŒœæµ‹..." onkeypress="if(event.key==='Enter') sendChat()">
                <button onclick="sendChat()">å‘é€</button>
            </div>
        </div>
    </div>
</div>

<!-- æˆ¿ä¸»è¾“å…¥è¯è¯­çš„å¼¹çª— -->
<div id="host-input-modal">
    <div class="modal-content">
        <h3 style="margin-top:0">P1 è¯·å‡ºé¢˜ (5ä¸ªè¯)</h3>
        <input type="text" id="word1" placeholder="è¯è¯­ 1 (å¦‚: è‹¹æœ)">
        <input type="text" id="word2" placeholder="è¯è¯­ 2">
        <input type="text" id="word3" placeholder="è¯è¯­ 3">
        <input type="text" id="word4" placeholder="è¯è¯­ 4">
        <input type="text" id="word5" placeholder="è¯è¯­ 5">
        <div style="display:flex; gap:10px; margin-top:10px;">
            <button onclick="submitWords()" style="flex:1; background:#dc3545; color:white; font-weight:bold;">å¼€å§‹æŒ‘æˆ˜ï¼</button>
            <button onclick="document.getElementById('host-input-modal').style.display='none'" style="background:#6c757d;">å–æ¶ˆ</button>
        </div>
    </div>
</div>

<script>
    // --- æ¸¸æˆé…ç½® ---
    const DRAW_TIME = 2;    // ä¿®æ”¹ï¼šæ”¹ä¸º10ç§’æ–¹ä¾¿æµ‹è¯•
    const PREPARE_TIME = 1;  // å‡†å¤‡æ—¶é—´
    
    // --- çŠ¶æ€å˜é‡ ---
    let peer = null;
    let myId = null;
    let myName = "ç©å®¶";
    let myRoleTag = "OBS"; // P1, P2, P3, OBS
    let isHost = false;
    let connections = []; 
    let hostConn = null;  
    
    // ç©å®¶æ•°æ®
    let players = []; 
    
    // æ¸¸æˆæ•°æ®
    let gameWords = [];
    let savedImages = []; 
    let currentWordIndex = 0;
    let timerInterval = null;
    let isGameRunning = false;
    let isGalleryPhase = false; 
    let solvedIndices = []; 

    // ç”»å¸ƒ
    const canvas = document.getElementById('canvas');
    const ctx = canvas.getContext('2d');
    let isDrawing = false;

    // --- åˆå§‹åŒ–ç”»å¸ƒå°ºå¯¸ ---
    function resizeCanvas() {
        const wrapper = document.getElementById('canvas-wrapper');
        if(wrapper) {
            canvas.width = wrapper.clientWidth;
            canvas.height = wrapper.clientHeight;
        }
    }
    window.addEventListener('resize', resizeCanvas);
    // é¡µé¢åŠ è½½åå»¶è¿Ÿä¸€ä¸‹å†è°ƒæ•´ï¼Œç¡®ä¿å®¹å™¨å·²æ¸²æŸ“
    setTimeout(resizeCanvas, 100);

    // --- è¾…åŠ©å‡½æ•° ---
    function getP2() { return players.find(p => p.roleTag === 'P2'); }
    function hasP3() { return players.some(p => p.roleTag === 'P3'); }
    function setStatus(html) { document.getElementById('connection-status').innerHTML = html; }

    // --- 1. ç½‘ç»œè¿æ¥ ---
    function initPeer(customId) {
        const peerConfig = {
            debug: 1,
            config: {
                'iceServers': [
                    { url: 'stun:stun.l.google.com:19302' },
                    { url: 'stun:stun1.l.google.com:19302' }
                ]
            }
        };

        peer = customId ? new Peer(customId, peerConfig) : new Peer(null, peerConfig);
        
        peer.on('open', id => {
            myId = id;
            document.getElementById('conn-panel').style.display = 'none';
            document.getElementById('my-role-display').innerHTML = `æˆ‘æ˜¯: <b>${myName}</b> | æˆ¿é—´å·: <span style="color:blue">${id}</span>`;
            addMsg('ç³»ç»Ÿ', `âœ… è¿æ¥æˆåŠŸï¼æˆ¿é—´å·ï¼š${id}`, true);
            resizeCanvas(); // è¿æ¥æˆåŠŸåå†è°ƒæ•´ä¸€æ¬¡ç”»å¸ƒ
        });

        peer.on('error', err => {
            console.error(err);
            let msg = "è¿æ¥é”™è¯¯";
            if (err.type === 'unavailable-id') msg = "âŒ æˆ¿é—´å·å·²è¢«å ç”¨ï¼";
            if (err.type === 'peer-unavailable') msg = "âŒ æ‰¾ä¸åˆ°æˆ¿é—´ï¼";
            setStatus(`<span style="color:red">${msg}</span>`);
        });

        peer.on('disconnected', () => {
             addMsg('ç³»ç»Ÿ', 'âš ï¸ æ–­å¼€ï¼Œå°è¯•é‡è¿...', true);
             peer.reconnect();
        });
    }

    function keepAlive(conn) {
        const pingInterval = setInterval(() => {
            if (conn && conn.open) conn.send({ type: 'ping' });
            else clearInterval(pingInterval);
        }, 5000);
    }

    function createRoom() {
        const roomId = document.getElementById('room-id-input').value.trim();
        if(!roomId) return setStatus('<span style="color:red">è¯·è¾“å…¥æˆ¿é—´å·ï¼</span>');
        
        myName = document.getElementById('nickname').value + " (æˆ¿ä¸»)";
        isHost = true;
        myRoleTag = 'P1';
        
        setStatus('æ­£åœ¨åˆ›å»ºæˆ¿é—´...');
        initPeer(roomId);
        
        players = [{ id: 'HOST', name: myName, roleName: 'å‡ºé¢˜è€…(P1)', roleTag: 'P1' }];
        updateUI();
        
        setTimeout(() => {
            if(peer) {
                peer.on('connection', conn => {
                    conn.on('open', () => {
                        connections.push(conn);
                        keepAlive(conn);
                        conn.on('data', data => handleHostData(data, conn));
                        conn.on('close', () => {
                            connections = connections.filter(c => c !== conn);
                            players = players.filter(p => p.id !== conn.peer);
                            broadcast({ type: 'update_players', players: players });
                        });
                        // åŒæ­¥å½“å‰ç”»å¸ƒç»™æ–°ç©å®¶ï¼ˆå¦‚æœåœ¨ç­‰å¾…é˜¶æ®µï¼‰
                        if(!isGameRunning) {
                            const img = canvas.toDataURL();
                            conn.send({type: 'sync_canvas', img: img});
                        }
                    });
                });
            }
        }, 100);
    }

    function joinRoom() {
        const roomId = document.getElementById('room-id-input').value.trim();
        if(!roomId) return setStatus('<span style="color:red">è¯·è¾“å…¥æˆ¿é—´å·ï¼</span>');
        
        myName = document.getElementById('nickname').value;
        const roleReq = document.getElementById('role-select').value;
        
        isHost = false;
        setStatus('æ­£åœ¨è¿æ¥æœåŠ¡å™¨...');
        initPeer(null); 

        const checkPeerOpen = setInterval(() => {
            if (peer && !peer.disconnected && !peer.destroyed && myId) {
                clearInterval(checkPeerOpen);
                setStatus(`æ­£åœ¨åŠ å…¥æˆ¿é—´ ${roomId}...`);
                hostConn = peer.connect(roomId);
                hostConn.on('open', () => {
                    setStatus('<span style="color:green">å·²è¿æ¥ï¼</span>');
                    keepAlive(hostConn);
                    hostConn.send({ type: 'join', name: myName, roleReq: roleReq });
                });
                hostConn.on('data', handleClientData);
                hostConn.on('close', () => { alert("ä¸æˆ¿ä¸»æ–­å¼€è¿æ¥ï¼"); location.reload(); });
            }
        }, 500);
    }

    // --- 2. æˆ¿ä¸»é€»è¾‘ ---

    function handleHostData(data, conn) {
        if (data.type === 'ping') return;

        if (data.type === 'join') {
            let assignedRoleName = 'è§‚ä¼—';
            let assignedRoleTag = 'OBS';
            let warningMsg = '';
            const isP2Taken = players.some(p => p.roleTag === 'P2');
            
            if (data.roleReq === 'P2') {
                if (!isP2Taken) { assignedRoleName = 'ç”»æ‰‹ (P2)'; assignedRoleTag = 'P2'; } 
                else { warningMsg = '(P2å·²æ»¡)'; }
            } else if (data.roleReq === 'P3') {
                assignedRoleName = 'çŒœé¢˜ (P3)'; assignedRoleTag = 'P3';
            }

            players = players.filter(p => p.id !== conn.peer);
            players.push({ id: conn.peer, name: data.name, roleName: assignedRoleName, roleTag: assignedRoleTag });
            
            broadcast({ type: 'update_players', players: players });
            broadcast({ type: 'chat', name: 'ç³»ç»Ÿ', msg: `${data.name} åŠ å…¥ ${warningMsg}`, isSys: true });
            conn.send({ type: 'you_are', roleTag: assignedRoleTag });

            if (getP2() && hasP3() && !isGameRunning) {
                document.getElementById('host-input-modal').style.display = 'flex';
            }
        }
        
        // ä¿®æ”¹ï¼šå…è®¸éæ¸¸æˆçŠ¶æ€ä¸‹çš„è‡ªç”±ç»˜ç”»ï¼Œæˆ–è€…æ¸¸æˆçŠ¶æ€ä¸‹çš„P2ç»˜ç”»
        if (data.type === 'draw' || data.type === 'clear') {
            const p2 = getP2();
            const isSenderP2 = (p2 && conn.peer === p2.id);
            
            // å…è®¸ç»˜åˆ¶çš„æ¡ä»¶ï¼šæ¸¸æˆæœªå¼€å§‹ OR å‘é€è€…æ˜¯P2
            if (!isGameRunning || isSenderP2) {
                if(data.type === 'draw') drawLocal(data.x, data.y, data.isStart);
                else ctx.clearRect(0,0,canvas.width, canvas.height);
                
                // è½¬å‘ç»™å…¶ä»–äºº
                connections.forEach(c => {
                    if(c.peer !== conn.peer) c.send(data);
                });
            }
        }

        if (data.type === 'chat') {
            broadcast({ type: 'chat', name: data.name, msg: data.msg });
            if (isGalleryPhase) checkGuess(data.msg, data.name);
        }
    }

    function submitWords() {
        if(!getP2() || !hasP3()) return alert("éœ€è¦ P2(ç”»æ‰‹) å’Œ P3(çŒœé¢˜) æ‰èƒ½å¼€å§‹ï¼");
        const inputs = [1,2,3,4,5].map(i => document.getElementById('word'+i).value.trim());
        if (inputs.some(w => !w)) return alert("è¯·å¡«æ»¡5ä¸ªè¯ï¼");
        
        gameWords = inputs;
        savedImages = [];
        solvedIndices = [];
        document.getElementById('host-input-modal').style.display = 'none';
        
        isGameRunning = true;
        isGalleryPhase = false;
        currentWordIndex = -1;
        
        broadcast({ type: 'chat', name: 'ç³»ç»Ÿ', msg: `ğŸ® æ¸¸æˆå¼€å§‹ï¼`, isSys: true });
        nextWord();
    }

    function nextWord() {
        currentWordIndex++;
        clearInterval(timerInterval);

        if (currentWordIndex >= 5) {
            startGalleryPhase();
            return;
        }

        const word = gameWords[currentWordIndex];
        let prepTime = PREPARE_TIME;
        broadcastState('prepare', word, prepTime); 
        
        timerInterval = setInterval(() => {
            prepTime--;
            if (prepTime > 0) {
                broadcastState('prepare', word, prepTime);
            } else {
                clearInterval(timerInterval);
                startDrawingPhase(word);
            }
        }, 1000);
    }

    function startDrawingPhase(word) {
        ctx.clearRect(0,0,canvas.width, canvas.height);
        broadcast({ type: 'clear' }, 'HOST'); // æ¸…ç©ºæ‰€æœ‰äººç”»æ¿

        let drawTime = DRAW_TIME;
        broadcastState('drawing', word, drawTime);

        timerInterval = setInterval(() => {
            drawTime--;
            if (drawTime >= 0) {
                broadcastState('drawing', word, drawTime);
            } else {
                clearInterval(timerInterval);
                const imgData = canvas.toDataURL("image/png");
                savedImages.push(imgData);
                broadcast({ type: 'chat', name: 'ç³»ç»Ÿ', msg: `ğŸ“¸ å›¾ ${currentWordIndex+1} å·²ä¿å­˜`, isSys: true });
                setTimeout(nextWord, 1000);
            }
        }, 1000);
    }

    function startGalleryPhase() {
        isGalleryPhase = true;
        isGameRunning = false; // æ¸¸æˆé€»è¾‘ç»“æŸï¼Œè¿›å…¥çœ‹å›¾æ¨¡å¼
        broadcast({ type: 'chat', name: 'ç³»ç»Ÿ', msg: 'ğŸ”¥ æŠ¢ç­”å¼€å§‹ï¼', isSys: true });
        const galleryData = { type: 'show_gallery', images: savedImages };
        broadcast(galleryData, 'HOST'); 
        handleClientData(galleryData); 
    }

    function checkGuess(msg, playerName) {
        gameWords.forEach((word, idx) => {
            if (solvedIndices.includes(idx)) return;
            if (msg.includes(word)) {
                solvedIndices.push(idx);
                const winMsg = `ğŸ‰ ${playerName} ç­”å¯¹ç¬¬ ${idx+1} é¢˜ï¼šã€${word}ã€‘`;
                broadcast({ type: 'solve_word', index: idx, word: word, msg: winMsg });
                updateGalleryItem(idx, word);
                addMsg('ç³»ç»Ÿ', winMsg, false, true);
            }
        });
    }

    function broadcastState(phase, word, time) {
        const data = { type: 'state_update', phase: phase, time: time, word: word, index: currentWordIndex + 1 };
        updateGameUI(data); 
        connections.forEach(conn => {
            const p = players.find(pl => pl.id === conn.peer);
            if (!p) return;
            if (p.roleTag === 'P3' || p.roleTag === 'OBS') conn.send({...data, word: '???'});
            else conn.send(data);
        });
    }

    function broadcast(data, excludeId) {
        connections.forEach(c => { if(c.peer !== excludeId) c.send(data); });
        if (isHost && excludeId !== 'HOST') {
            if(data.type === 'update_players') updateUI();
            if(data.type === 'chat') addMsg(data.name, data.msg, data.isSys, data.isWin);
        }
    }

    // --- 3. å®¢æˆ·ç«¯é€»è¾‘ ---

    function handleClientData(data) {
        if (data.type === 'ping') return;
        if (data.type === 'you_are') {
            myRoleTag = data.roleTag; 
            document.getElementById('my-role-display').innerHTML += ` | è§’è‰²: <b>${data.roleTag}</b>`;
        }
        if (data.type === 'update_players') { players = data.players; updateUI(); }
        if (data.type === 'chat') addMsg(data.name, data.msg, data.isSys, data.isWin);
        if (data.type === 'draw') drawLocal(data.x, data.y, data.isStart);
        if (data.type === 'clear') ctx.clearRect(0,0,canvas.width, canvas.height);
        if (data.type === 'state_update') updateGameUI(data);
        if (data.type === 'show_gallery') renderGallery(data.images);
        if (data.type === 'solve_word') { updateGalleryItem(data.index, data.word); addMsg('ç³»ç»Ÿ', data.msg, false, true); }
        if (data.type === 'sync_canvas') {
            const img = new Image();
            img.onload = () => ctx.drawImage(img, 0, 0);
            img.src = data.img;
        }
    }

    // --- 4. UI æ›´æ–° ---

    function renderGallery(images) {
        document.getElementById('canvas-wrapper').style.display = 'none';
        const gView = document.getElementById('gallery-view');
        gView.style.display = 'flex';
        gView.innerHTML = images.map((src, i) => `
            <div class="gallery-item" id="g-item-${i}">
                <div class="label">#${i+1}</div>
                <img src="${src}">
                <div class="answer" id="ans-${i}">???</div>
            </div>
        `).join('');
    }

    function updateGalleryItem(index, word) {
        const item = document.getElementById(`g-item-${index}`);
        const ans = document.getElementById(`ans-${index}`);
        if(item && ans) { item.classList.add('solved'); ans.innerText = word; }
    }

    function updateUI() {
        const html = players.map(p => `
            <div class="p-card">
                <span>${p.name} ${p.id===(isHost?'HOST':myId) ? '(æˆ‘)':''}</span>
                <span class="role-badge role-${p.roleTag}">${p.roleName}</span>
            </div>
        `).join('');
        document.getElementById('p-list-content').innerHTML = html;
        
        // æŒ‰é’®çŠ¶æ€æ›´æ–°ï¼šæ¸¸æˆæœªå¼€å§‹æ—¶ï¼Œå¤§å®¶éƒ½å¯ä»¥æ¸…ç©º
        const btnClear = document.getElementById('btn-clear');
        if (!isGameRunning) btnClear.disabled = false;
        else btnClear.disabled = (myRoleTag !== 'P2');
    }

    function updateGameUI(data) {
        document.getElementById('canvas-wrapper').style.display = 'flex';
        document.getElementById('gallery-view').style.display = 'none';
        const overlay = document.getElementById('status-overlay');
        const text = document.getElementById('overlay-text');
        const timer = document.getElementById('timer-display');
        const blocker = document.getElementById('blocker');
        
        overlay.style.display = 'block';
        timer.innerText = data.time;
        
        const amIDrawer = (myRoleTag === 'P2');

        if (data.phase === 'prepare') {
            overlay.style.background = 'rgba(0,0,0,0.9)';
            text.innerHTML = `ç¬¬ ${data.index}/5 é¢˜<br>å‡†å¤‡! é¢˜ç›®: <span style="color:#ff5722; font-size:24px">${data.word}</span>`;
            blocker.style.display = 'block'; 
        } else if (data.phase === 'drawing') {
            if (amIDrawer) {
                overlay.style.background = 'rgba(0,128,0,0.1)'; 
                overlay.style.pointerEvents = 'none';
                text.innerHTML = `ğŸ”¥ ç”»: ${data.word}`;
                timer.style.color = 'red';
                blocker.style.display = 'none';
            } else {
                overlay.style.background = 'rgba(0,0,0,0.95)'; 
                text.innerHTML = `P2 æ­£åœ¨ä½œç”»... (ç¬¬ ${data.index} å¼ )`;
                blocker.style.display = 'block';
            }
        }
    }

    function addMsg(name, msg, isSys, isWin) {
        const div = document.createElement('div');
        div.className = `msg ${isSys?'sys':''} ${isWin?'win':''}`;
        div.innerHTML = (isSys||isWin) ? msg : `<b>${name}:</b> ${msg}`;
        const box = document.getElementById('messages');
        box.appendChild(div);
        box.scrollTop = box.scrollHeight;
    }

    function sendChat() {
        const input = document.getElementById('msg-input');
        const val = input.value.trim();
        if(!val) return;
        if (isHost) {
            broadcast({ type: 'chat', name: myName, msg: val });
            if(isGalleryPhase) checkGuess(val, myName);
            addMsg(myName, val);
        } else {
            if(hostConn && hostConn.open) hostConn.send({ type: 'chat', msg: val, name: myName });
        }
        input.value = '';
    }

    // --- 5. ç”»æ¿é€»è¾‘ (ä¿®æ”¹ç‰ˆ) ---
    function getPos(e) {
        const rect = canvas.getBoundingClientRect();
        const t = e.changedTouches ? e.changedTouches[0] : e;
        return { 
            x: (t.clientX - rect.left) / canvas.width, 
            y: (t.clientY - rect.top) / canvas.height 
        };
    }

    function startDraw(e) {
        // ä¿®æ”¹ï¼šå…è®¸åœ¨æ¸¸æˆæœªå¼€å§‹æ—¶ï¼Œæˆ–è€…æ¸¸æˆè¿›è¡Œä¸­ä¸”æˆ‘æ˜¯P2æ—¶ç»˜ç”»
        const canDraw = (!isGameRunning) || (isGameRunning && myRoleTag === 'P2');
        
        if (!isDrawing && canDraw) { 
            isDrawing = true;
            const p = getPos(e);
            drawLocal(p.x, p.y, true);
            
            const drawData = { type: 'draw', x: p.x, y: p.y, isStart: true };
            if(!isHost) hostConn.send(drawData);
            else broadcast(drawData, 'HOST'); // æˆ¿ä¸»åœ¨ç­‰å¾…å¤§å…ç”»ç”»æ—¶å¹¿æ’­ç»™åˆ«äºº
        }
    }

    function moveDraw(e) {
        if (!isDrawing) return;
        e.preventDefault();
        const p = getPos(e);
        drawLocal(p.x, p.y, false);
        
        const drawData = { type: 'draw', x: p.x, y: p.y, isStart: false };
        if(!isHost) hostConn.send(drawData);
        else broadcast(drawData, 'HOST');
    }

    function stopDraw() { isDrawing = false; }

    function drawLocal(x, y, isStart) {
        const actualX = x * canvas.width;
        const actualY = y * canvas.height;
        ctx.lineWidth = 4;
        ctx.lineCap = 'round';
        ctx.strokeStyle = '#000';
        if (isStart) { ctx.beginPath(); ctx.moveTo(actualX, actualY); }
        else { ctx.lineTo(actualX, actualY); ctx.stroke(); }
    }
    
    function clearCanvas() {
        // ä¿®æ”¹ï¼šæ¸¸æˆæœªå¼€å§‹æ—¶å…è®¸ä»»ä½•äººæ¸…ç©º
        if (!isGameRunning || myRoleTag === 'P2') {
            ctx.clearRect(0,0,canvas.width, canvas.height);
            const data = { type: 'clear' };
            if(!isHost) hostConn.send(data);
            else broadcast(data, 'HOST');
        }
    }

    canvas.addEventListener('mousedown', startDraw);
    canvas.addEventListener('mousemove', moveDraw);
    canvas.addEventListener('mouseup', stopDraw);
    canvas.addEventListener('mouseout', stopDraw);
    canvas.addEventListener('touchstart', startDraw, {passive: false});
    canvas.addEventListener('touchmove', moveDraw, {passive: false});
    canvas.addEventListener('touchend', stopDraw);
</script>

</body>
</html>
