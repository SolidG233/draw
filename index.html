<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æé€Ÿä½ ç”»æˆ‘çŒœ (3ç§’è¿ç”»ç‰ˆ)</title>
    <script src="https://unpkg.com/peerjs@1.5.2/dist/peerjs.min.js"></script>
    <style>
        body { font-family: 'Segoe UI', sans-serif; background: #f0f2f5; display: flex; flex-direction: column; align-items: center; padding: 10px; margin: 0; }
        
        /* é¡¶éƒ¨ */
        header { width: 100%; max-width: 1000px; background: #fff; padding: 15px; border-radius: 8px; box-shadow: 0 2px 5px rgba(0,0,0,0.05); margin-bottom: 15px; display: flex; justify-content: space-between; align-items: center; }
        h1 { margin: 0; font-size: 22px; color: #333; }
        
        /* æ¸¸æˆæ ¸å¿ƒåŒº */
        #game-container { display: flex; gap: 15px; width: 100%; max-width: 1000px; height: 600px; }
        
        /* å·¦ä¾§ç”»æ¿åŒº */
        #left-panel { flex: 2; display: flex; flex-direction: column; gap: 10px; position: relative; }
        
        #canvas-wrapper { position: relative; flex: 1; background: #fff; border: 2px solid #333; border-radius: 4px; display: flex; justify-content: center; align-items: center; overflow: hidden; }
        canvas { display: block; touch-action: none; }
        
        /* ç”»å»Šè§†å›¾ (æœ€åå±•ç¤ºç”¨) */
        #gallery-view { 
            display: none; flex: 1; background: #fff; border-radius: 4px; padding: 10px; 
            flex-wrap: wrap; gap: 10px; justify-content: center; overflow-y: auto; align-content: flex-start;
        }
        .gallery-item { width: 30%; height: 150px; border: 1px solid #ccc; position: relative; display: flex; flex-direction: column; }
        .gallery-item img { width: 100%; height: 100%; object-fit: contain; background: white; }
        .gallery-item .label { position: absolute; top: 0; left: 0; background: #007bff; color: white; padding: 2px 6px; font-size: 12px; }
        .gallery-item .answer { background: #28a745; color: white; text-align: center; font-weight: bold; padding: 5px; display: none; }
        .gallery-item.solved .answer { display: block; }
        .gallery-item.solved { border: 2px solid #28a745; }

        /* é®ç½©ä¸æç¤º */
        #blocker { position: absolute; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.1); z-index: 10; display: none; cursor: not-allowed; }
        
        #status-overlay { 
            position: absolute; top: 20px; left: 50%; transform: translateX(-50%); 
            background: rgba(0,0,0,0.8); color: white; padding: 10px 20px; 
            border-radius: 30px; font-size: 20px; font-weight: bold; pointer-events: none; z-index: 20; text-align: center;
            min-width: 200px;
        }
        #timer-display { font-size: 40px; color: #ffeb3b; display: block; margin-top: 5px; font-weight: 900; }

        /* å³ä¾§èŠå¤© */
        #right-panel { flex: 1; display: flex; flex-direction: column; gap: 10px; }
        #player-list { background: #fff; padding: 10px; border-radius: 8px; min-height: 80px; }
        .p-card { padding: 5px; border-bottom: 1px solid #eee; display: flex; justify-content: space-between; font-size: 14px; }
        
        #chat-box { flex: 1; background: #fff; border-radius: 8px; display: flex; flex-direction: column; overflow: hidden; }
        #messages { flex: 1; overflow-y: auto; padding: 10px; background: #f9f9f9; }
        .msg { margin-bottom: 6px; font-size: 14px; }
        .msg.sys { color: #888; text-align: center; font-style: italic; margin: 10px 0; }
        .msg.win { background: #d4edda; color: #155724; padding: 5px; text-align: center; border-radius: 4px; font-weight: bold; }
        
        #input-area { padding: 10px; display: flex; gap: 5px; border-top: 1px solid #eee; }
        input[type=text] { flex: 1; padding: 8px; border: 1px solid #ddd; border-radius: 4px; }
        button { padding: 8px 15px; background: #007bff; color: white; border: none; border-radius: 4px; cursor: pointer; }

        /* è¿æ¥é¢æ¿ */
        #conn-panel { background: #fff; padding: 15px; border-radius: 8px; margin-bottom: 10px; }

        /* æˆ¿ä¸»å‡ºé¢˜å¼¹çª— */
        #host-input-modal { 
            position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); 
            z-index: 100; display: none; justify-content: center; align-items: center; 
        }
        .modal-content { background: white; padding: 20px; border-radius: 8px; width: 300px; }
        .modal-content input { width: 100%; margin-bottom: 10px; box-sizing: border-box; }
    </style>
</head>
<body>

<header>
    <div>
        <h1>âš¡ æé€Ÿè¿ç”»æŒ‘æˆ˜ (3ç§’ç‰ˆ)</h1>
        <div style="font-size:12px; color:#666;">è§„åˆ™: P2è¿ç»­ç”»5å¼ (æ¯å¼ 3ç§’)ï¼Œæœ€åP3ç»Ÿä¸€çœ‹å›¾çŒœ</div>
    </div>
    <div id="my-role-display">ç­‰å¾…è¿æ¥...</div>
</header>

<div id="conn-panel">
    <div id="setup-box">
        <label>æ˜µç§°:</label> <input type="text" id="nickname" value="ç©å®¶" style="width:80px">
        <button onclick="createRoom()">æˆ‘æ˜¯æˆ¿ä¸»(P1 å‡ºé¢˜)</button>
        <input type="text" id="host-id" placeholder="è¾“å…¥æˆ¿ä¸»ID">
        <button onclick="joinRoom()">åŠ å…¥æˆ¿é—´</button>
    </div>
    <div id="id-info" style="margin-top:5px; color:#007bff; font-weight:bold;"></div>
</div>

<div id="game-container">
    <div id="left-panel">
        <!-- ç”»å¸ƒæ¨¡å¼ -->
        <div id="canvas-wrapper">
            <canvas id="canvas" width="600" height="450"></canvas>
            <div id="blocker"></div>
            <div id="status-overlay" style="display:none;">
                <div id="overlay-text">ç­‰å¾…å¼€å§‹</div>
                <div id="timer-display"></div>
            </div>
        </div>
        <!-- ç”»å»Šæ¨¡å¼ (æœ€åæ˜¾ç¤º) -->
        <div id="gallery-view"></div>

        <div style="display:flex; gap:10px; justify-content:center; margin-top:5px;">
            <button onclick="clearCanvas()">æ¸…ç©ºç”»æ¿</button>
        </div>
    </div>

    <div id="right-panel">
        <div id="player-list">
            <div style="font-weight:bold; margin-bottom:5px;">ç©å®¶åˆ—è¡¨:</div>
            <div id="p-list-content">ç­‰å¾…åŠ å…¥...</div>
        </div>
        <div id="chat-box">
            <div id="messages"></div>
            <div id="input-area">
                <input type="text" id="msg-input" placeholder="è¾“å…¥çŒœæµ‹..." onkeypress="if(event.key==='Enter') sendChat()">
                <button onclick="sendChat()">å‘é€</button>
            </div>
        </div>
    </div>
</div>

<!-- æˆ¿ä¸»è¾“å…¥è¯è¯­çš„å¼¹çª— -->
<div id="host-input-modal">
    <div class="modal-content">
        <h3>P1 è¯·å‡ºé¢˜ (5ä¸ªè¯)</h3>
        <input type="text" id="word1" placeholder="è¯è¯­ 1">
        <input type="text" id="word2" placeholder="è¯è¯­ 2">
        <input type="text" id="word3" placeholder="è¯è¯­ 3">
        <input type="text" id="word4" placeholder="è¯è¯­ 4">
        <input type="text" id="word5" placeholder="è¯è¯­ 5">
        <button onclick="submitWords()" style="width:100%; background:#dc3545; color:white; font-weight:bold;">å¼€å§‹åœ°ç‹±çº§3ç§’æŒ‘æˆ˜ï¼</button>
    </div>
</div>

<script>
    // --- æ¸¸æˆé…ç½® ---
    const DRAW_TIME = 2; // æ ¸å¿ƒä¿®æ”¹ï¼šåªæœ‰3ç§’
    const PREPARE_TIME = 1; // å‡†å¤‡æ—¶é—´
    
    // --- çŠ¶æ€å˜é‡ ---
    let peer = null;
    let myId = null;
    let myName = "ç©å®¶";
    let isHost = false;
    let connections = []; 
    let hostConn = null;  
    let players = []; 
    
    // æ¸¸æˆæ•°æ®
    let gameWords = [];
    let savedImages = []; // å­˜å‚¨5å¼ ç”»çš„Base64
    let currentWordIndex = 0;
    let timerInterval = null;
    let isGameRunning = false;
    let isGalleryPhase = false; // æ˜¯å¦è¿›å…¥æœ€åçš„çŒœé¢˜é˜¶æ®µ
    let solvedIndices = []; // å“ªäº›é¢˜è¢«çŒœå‡ºæ¥äº†

    // ç”»å¸ƒ
    const canvas = document.getElementById('canvas');
    const ctx = canvas.getContext('2d');
    let isDrawing = false;

    // --- 1. ç½‘ç»œè¿æ¥ ---
    function initPeer() {
        peer = new Peer(null, { debug: 1 });
        peer.on('open', id => {
            myId = id;
            document.getElementById('id-info').innerText = `ID: ${id}`;
        });
        peer.on('error', err => alert("è¿æ¥é”™è¯¯:" + err.type));
    }

    function createRoom() {
        myName = document.getElementById('nickname').value + " (P1)";
        isHost = true;
        initPeer();
        players = [{ id: 'HOST', name: myName, role: 'å‡ºé¢˜è€…' }];
        updateUI();
        document.getElementById('setup-box').innerHTML = `<b>æˆ¿é—´å·²åˆ›å»ºï¼ç­‰å¾…P2å’ŒP3...</b> <button onclick="copyId()">å¤åˆ¶ID</button>`;
        
        peer.on('connection', conn => {
            conn.on('open', () => {
                connections.push(conn);
                conn.on('data', data => handleHostData(data, conn));
            });
        });
    }

    function joinRoom() {
        const hostId = document.getElementById('host-id').value;
        if(!hostId) return alert("è¯·è¾“å…¥æˆ¿ä¸»ID");
        myName = document.getElementById('nickname').value;
        isHost = false;
        initPeer();
        document.getElementById('setup-box').innerHTML = `æ­£åœ¨è¿æ¥...`;

        setTimeout(() => {
            hostConn = peer.connect(hostId);
            hostConn.on('open', () => {
                document.getElementById('setup-box').innerHTML = `<b style="color:green">å·²åŠ å…¥ï¼</b>`;
                hostConn.send({ type: 'join', name: myName });
            });
            hostConn.on('data', handleClientData);
        }, 1000);
    }

    function copyId() { navigator.clipboard.writeText(myId); }

    // --- 2. æˆ¿ä¸»é€»è¾‘ (æ ¸å¿ƒæ§åˆ¶) ---

    function handleHostData(data, conn) {
        if (data.type === 'join') {
            if (players.length >= 3) return;
            let role = players.length === 1 ? 'ç”»æ‰‹ (P2)' : 'çŒœé¢˜ (P3)';
            players.push({ id: conn.peer, name: data.name, role: role });
            
            broadcast({ type: 'update_players', players: players });
            broadcast({ type: 'chat', name: 'ç³»ç»Ÿ', msg: `${data.name} åŠ å…¥ (${role})`, isSys: true });

            if (players.length === 3) document.getElementById('host-input-modal').style.display = 'flex';
        }
        
        if (data.type === 'draw' || data.type === 'clear') {
            // åªæœ‰P2èƒ½ç”»
            if (players[1] && conn.peer === players[1].id) {
                // å…³é”®ä¿®æ”¹ï¼šç”»ç”»é˜¶æ®µï¼Œåªå¹¿æ’­ç»™P1(æˆ¿ä¸»è‡ªå·±)çœ‹ï¼Œä¸å‘ç»™P3(çŒœé¢˜è€…)
                // P3æ­¤æ—¶åº”è¯¥ä»€ä¹ˆéƒ½çœ‹ä¸åˆ°ï¼Œæˆ–è€…åªèƒ½çœ‹åˆ°å€’è®¡æ—¶
                
                // 1. æˆ¿ä¸»è‡ªå·±ç”»
                if(data.type === 'draw') drawLocal(data.x, data.y, data.isStart);
                else ctx.clearRect(0,0,canvas.width, canvas.height);

                // 2. å¦‚æœæ˜¯ç”»å»Šé˜¶æ®µ(ç†è®ºä¸Šä¸ä¼š)ï¼Œæˆ–è€…ç‰¹æ®Šéœ€æ±‚ï¼Œæ‰å¹¿æ’­ç»™P3ã€‚
                // è¿™é‡Œæˆ‘ä»¬é€‰æ‹©ï¼šä½œç”»è¿‡ç¨‹å®Œå…¨å¯¹P3ä¿å¯†ã€‚
            }
        }

        if (data.type === 'chat') {
            broadcast({ type: 'chat', name: data.name, msg: data.msg });
            // æ£€æŸ¥çŒœé¢˜ (åªåœ¨ç”»å»Šé˜¶æ®µæœ‰æ•ˆ)
            if (isGalleryPhase) checkGuess(data.msg);
        }
    }

    function submitWords() {
        const inputs = [1,2,3,4,5].map(i => document.getElementById('word'+i).value.trim());
        if (inputs.some(w => !w)) return alert("è¯·å¡«æ»¡5ä¸ªè¯ï¼");
        
        gameWords = inputs;
        savedImages = [];
        solvedIndices = [];
        document.getElementById('host-input-modal').style.display = 'none';
        
        isGameRunning = true;
        isGalleryPhase = false;
        currentWordIndex = -1;
        
        broadcast({ type: 'chat', name: 'ç³»ç»Ÿ', msg: 'æ¸¸æˆå¼€å§‹ï¼P2å°†è¿ç»­ç”»5å¼ å›¾ï¼Œæ¯å¼ åªæœ‰3ç§’ï¼', isSys: true });
        
        nextWord();
    }

    function nextWord() {
        currentWordIndex++;
        clearInterval(timerInterval);

        // å¦‚æœç”»å®Œäº†5ä¸ª
        if (currentWordIndex >= 5) {
            startGalleryPhase();
            return;
        }

        const word = gameWords[currentWordIndex];
        
        // 1. å‡†å¤‡é˜¶æ®µ
        let prepTime = PREPARE_TIME;
        broadcastState('prepare', word, prepTime); // å‘Šè¯‰å¤§å®¶ç¬¬å‡ é¢˜
        
        timerInterval = setInterval(() => {
            prepTime--;
            if (prepTime > 0) {
                broadcastState('prepare', word, prepTime);
            } else {
                clearInterval(timerInterval);
                startDrawingPhase(word);
            }
        }, 1000);
    }

    function startDrawingPhase(word) {
        // æ¸…ç©ºæˆ¿ä¸»å’ŒP2çš„ç”»å¸ƒ
        ctx.clearRect(0,0,canvas.width, canvas.height);
        // é€šçŸ¥P2æ¸…ç©º
        if(connections[0]) connections[0].send({ type: 'clear' }); 

        let drawTime = DRAW_TIME;
        broadcastState('drawing', word, drawTime);

        timerInterval = setInterval(() => {
            drawTime--;
            if (drawTime >= 0) {
                broadcastState('drawing', word, drawTime);
            } else {
                // æ—¶é—´åˆ°ï¼
                clearInterval(timerInterval);
                // æ ¸å¿ƒï¼šä¿å­˜å½“å‰ç”»å¸ƒä¸ºå›¾ç‰‡
                const imgData = canvas.toDataURL("image/png");
                savedImages.push(imgData);
                
                broadcast({ type: 'chat', name: 'ç³»ç»Ÿ', msg: `ç¬¬ ${currentWordIndex+1} å¼ å›¾å·²ä¿å­˜ï¼`, isSys: true });
                
                // è‡ªåŠ¨è¿›å…¥ä¸‹ä¸€é¢˜
                setTimeout(nextWord, 1000);
            }
        }, 1000);
    }

    function startGalleryPhase() {
        isGalleryPhase = true;
        broadcast({ type: 'chat', name: 'ç³»ç»Ÿ', msg: 'ğŸ”¥ ä½œç”»ç»“æŸï¼è¯·çœ‹å›¾çŒœè¯ï¼(è¾“å…¥ä»»æ„è¯è¯­å³å¯)', isSys: true });
        
        const galleryData = {
            type: 'show_gallery',
            images: savedImages
        };
        
        // å¹¿æ’­ç»™æ‰€æœ‰äººå±•ç¤ºç”»å»Š
        broadcast(galleryData, 'HOST'); // å‘ç»™P2, P3
        handleClientData(galleryData); // æˆ¿ä¸»è‡ªå·±ä¹Ÿæ˜¾ç¤º
    }

    function checkGuess(msg) {
        let newSolve = false;
        gameWords.forEach((word, idx) => {
            if (solvedIndices.includes(idx)) return; // å·²ç»çŒœå‡ºæ¥çš„è·³è¿‡
            
            if (msg.includes(word)) {
                solvedIndices.push(idx);
                newSolve = true;
                // å¹¿æ’­çŒœå¯¹ä¿¡æ¯
                broadcast({ 
                    type: 'solve_word', 
                    index: idx, 
                    word: word,
                    msg: `âœ… çŒœå¯¹äº†ç¬¬ ${idx+1} é¢˜ï¼šã€${word}ã€‘` 
                });
                // æˆ¿ä¸»è‡ªå·±æ›´æ–°
                updateGalleryItem(idx, word);
                addMsg('ç³»ç»Ÿ', `âœ… çŒœå¯¹äº†ç¬¬ ${idx+1} é¢˜ï¼šã€${word}ã€‘`, false, true);
            }
        });

        if (solvedIndices.length === 5) {
            broadcast({ type: 'chat', name: 'ç³»ç»Ÿ', msg: 'ğŸ‰ å…¨éƒ¨çŒœå¯¹ï¼æ¸¸æˆç»“æŸï¼', isWin: true });
        }
    }

    function broadcastState(phase, word, time) {
        // P3 åœ¨ä½œç”»é˜¶æ®µåªèƒ½çœ‹åˆ° "ä½œç”»ä¸­..."ï¼Œçœ‹ä¸åˆ°è¯ï¼Œä¹Ÿçœ‹ä¸åˆ°ç”»
        const data = {
            type: 'state_update',
            phase: phase,
            time: time,
            word: word,
            index: currentWordIndex + 1
        };
        
        updateGameUI(data); // æˆ¿ä¸»UI

        // å‘ç»™P2 (ç”»æ‰‹) - çœ‹è¯
        if(connections[0]) connections[0].send(data); 

        // å‘ç»™P3 (çŒœæ‰‹) - éšè—è¯
        if(connections[1]) {
            const secretData = {...data, word: '???'};
            connections[1].send(secretData);
        }
    }

    function broadcast(data, excludeId) {
        connections.forEach(c => {
            if(c.peer !== excludeId) c.send(data);
        });
        if (isHost && excludeId !== 'HOST') {
            if(data.type === 'update_players') updateUI();
            if(data.type === 'chat') addMsg(data.name, data.msg, data.isSys, data.isWin);
        }
    }

    // --- 3. å®¢æˆ·ç«¯é€»è¾‘ ---

    function handleClientData(data) {
        if (data.type === 'update_players') {
            players = data.players;
            updateUI();
        }
        if (data.type === 'chat') addMsg(data.name, data.msg, data.isSys, data.isWin);
        
        // P2 æœ¬åœ°ç”»ç”»å›æ˜¾ï¼ŒP3åœ¨ä½œç”»é˜¶æ®µä¸åº”è¯¥æ”¶åˆ°drawæŒ‡ä»¤(æˆ¿ä¸»è¿‡æ»¤äº†)
        if (data.type === 'draw') drawLocal(data.x, data.y, data.isStart);
        if (data.type === 'clear') ctx.clearRect(0,0,canvas.width, canvas.height);
        
        if (data.type === 'state_update') updateGameUI(data);
        
        if (data.type === 'show_gallery') {
            renderGallery(data.images);
        }
        
        if (data.type === 'solve_word') {
            updateGalleryItem(data.index, data.word);
            addMsg('ç³»ç»Ÿ', data.msg, false, true);
        }
    }

    // --- 4. UI æ›´æ–° ---

    function renderGallery(images) {
        // éšè—ç”»å¸ƒï¼Œæ˜¾ç¤ºç”»å»Š
        document.getElementById('canvas-wrapper').style.display = 'none';
        const gView = document.getElementById('gallery-view');
        gView.style.display = 'flex';
        
        gView.innerHTML = images.map((src, i) => `
            <div class="gallery-item" id="g-item-${i}">
                <div class="label">#${i+1}</div>
                <img src="${src}">
                <div class="answer" id="ans-${i}">???</div>
            </div>
        `).join('');
    }

    function updateGalleryItem(index, word) {
        const item = document.getElementById(`g-item-${index}`);
        const ans = document.getElementById(`ans-${index}`);
        if(item && ans) {
            item.classList.add('solved');
            ans.innerText = word;
        }
    }

    function updateUI() {
        let myRole = "è§‚ä¼—";
        if (myId === 'HOST' || (isHost)) myRole = "P1 å‡ºé¢˜";
        else if (players[1] && myId === players[1].id) myRole = "P2 ç”»æ‰‹";
        else if (players[2] && myId === players[2].id) myRole = "P3 çŒœé¢˜";
        document.getElementById('my-role-display').innerHTML = `æˆ‘æ˜¯: <b>${myRole}</b>`;

        const html = players.map(p => `
            <div class="p-card"><span>${p.name}</span><span>${p.role}</span></div>
        `).join('');
        document.getElementById('p-list-content').innerHTML = html;
    }

    function updateGameUI(data) {
        // ç¡®ä¿æ˜¾ç¤ºç”»å¸ƒï¼Œéšè—ç”»å»Š
        document.getElementById('canvas-wrapper').style.display = 'flex';
        document.getElementById('gallery-view').style.display = 'none';

        const overlay = document.getElementById('status-overlay');
        const text = document.getElementById('overlay-text');
        const timer = document.getElementById('timer-display');
        const blocker = document.getElementById('blocker');
        
        overlay.style.display = 'block';
        timer.innerText = data.time;
        
        const isDrawer = (players[1] && (myId === players[1].id));

        if (data.phase === 'prepare') {
            overlay.style.background = 'rgba(0,0,0,0.9)';
            text.innerHTML = `ç¬¬ ${data.index}/5 é¢˜<br>å‡†å¤‡! é¢˜ç›®: <span style="color:#ff5722; font-size:24px">${data.word}</span>`;
            blocker.style.display = 'block'; 
        } else if (data.phase === 'drawing') {
            if (isDrawer) {
                overlay.style.background = 'rgba(0,128,0,0.1)'; 
                overlay.style.pointerEvents = 'none';
                text.innerHTML = `ğŸ”¥ åªæœ‰3ç§’! ç”»: ${data.word}`;
                timer.style.color = 'red';
                blocker.style.display = 'none';
            } else {
                overlay.style.background = 'rgba(0,0,0,0.95)'; // é®å¾—ä¸¥ä¸¥å®å®
                text.innerHTML = `P2 æ­£åœ¨æé€Ÿä½œç”»... (ç¬¬ ${data.index} å¼ )`;
                blocker.style.display = 'block';
            }
        }
    }

    function addMsg(name, msg, isSys, isWin) {
        const div = document.createElement('div');
        div.className = `msg ${isSys?'sys':''} ${isWin?'win':''}`;
        div.innerHTML = (isSys||isWin) ? msg : `<b>${name}:</b> ${msg}`;
        const box = document.getElementById('messages');
        box.appendChild(div);
        box.scrollTop = box.scrollHeight;
    }

    function sendChat() {
        const input = document.getElementById('msg-input');
        const val = input.value.trim();
        if(!val) return;
        
        if (isHost) {
            broadcast({ type: 'chat', name: myName, msg: val });
            if(isGalleryPhase) checkGuess(val);
            addMsg(myName, val);
        } else {
            hostConn.send({ type: 'chat', msg: val, name: myName });
        }
        input.value = '';
    }

    // --- 5. ç”»æ¿é€»è¾‘ ---
    function getPos(e) {
        const rect = canvas.getBoundingClientRect();
        const t = e.changedTouches ? e.changedTouches[0] : e;
        return { x: t.clientX - rect.left, y: t.clientY - rect.top };
    }

    function startDraw(e) {
        if (!isDrawing && players[1] && (myId === players[1].id)) { 
            // åªæœ‰P2èƒ½å¼€å§‹ç”»
        }
        isDrawing = true;
        const p = getPos(e);
        drawLocal(p.x, p.y, true);
        if(!isHost) hostConn.send({ type: 'draw', x: p.x, y: p.y, isStart: true });
    }

    function moveDraw(e) {
        if (!isDrawing) return;
        e.preventDefault();
        const p = getPos(e);
        drawLocal(p.x, p.y, false);
        if(!isHost) hostConn.send({ type: 'draw', x: p.x, y: p.y, isStart: false });
    }

    function stopDraw() { isDrawing = false; }

    function drawLocal(x, y, isStart) {
        ctx.lineWidth = 4;
        ctx.lineCap = 'round';
        ctx.strokeStyle = '#000';
        if (isStart) { ctx.beginPath(); ctx.moveTo(x, y); }
        else { ctx.lineTo(x, y); ctx.stroke(); }
    }
    
    function clearCanvas() {
        if (players[1] && myId === players[1].id) {
            ctx.clearRect(0,0,canvas.width, canvas.height);
            hostConn.send({ type: 'clear' });
        }
    }

    canvas.addEventListener('mousedown', startDraw);
    canvas.addEventListener('mousemove', moveDraw);
    canvas.addEventListener('mouseup', stopDraw);
    canvas.addEventListener('mouseout', stopDraw);
    canvas.addEventListener('touchstart', startDraw);
    canvas.addEventListener('touchmove', moveDraw);
    canvas.addEventListener('touchend', stopDraw);

</script>
</body>
</html>
