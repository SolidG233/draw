<!DOCTYPE html>
<html lang="zh-CN">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>2024_Q1_è´¢åŠ¡æŠ¥è¡¨_æœ€ç»ˆç‰ˆ.xlsx - Excel</title>
<script src="https://unpkg.com/peerjs@1.4.7/dist/peerjs.min.js"></script>
<style>
/* --- å…¨å±€ Excel é£æ ¼é‡ç½® --- */
body, html { margin: 0; padding: 0; height: 100%; overflow: hidden; font-family: 'Calibri', 'Segoe UI', sans-serif; font-size: 13px; background: #fff; color: #333; }
* { box-sizing: border-box; user-select: none; }

/* é¡¶éƒ¨ç»¿æ¡ */
.excel-header { background: #217346; color: white; height: 35px; display: flex; align-items: center; padding: 0 15px; font-size: 14px; }
.excel-header span { margin-right: 20px; cursor: pointer; opacity: 0.9; }
.excel-header span:hover { opacity: 1; text-decoration: underline; }

/* å·¥å…·æ  (Ribbon) */
.ribbon { background: #f3f2f1; height: 50px; border-bottom: 1px solid #e1e1e1; display: flex; align-items: center; padding: 0 10px; gap: 10px; }
.ribbon-btn { display: flex; flex-direction: column; align-items: center; justify-content: center; padding: 5px 10px; border: 1px solid transparent; cursor: pointer; color: #444; border-radius: 3px; }
.ribbon-btn:hover { background: #c5c5c5; border-color: #a0a0a0; }
.ribbon-btn:disabled { opacity: 0.3; cursor: default; }
.ribbon-icon { font-size: 16px; margin-bottom: 2px; }
.ribbon-text { font-size: 11px; }

/* å…¬å¼æ  (èŠå¤©è¾“å…¥) */
.formula-bar { background: #fff; height: 28px; display: flex; align-items: center; padding: 2px 5px; border-bottom: 1px solid #e1e1e1; }
.name-box { width: 60px; height: 100%; border: 1px solid #d4d4d4; display: flex; align-items: center; justify-content: center; background: #fff; margin-right: 5px; color: #666; font-size: 12px; }
.fx-icon { width: 30px; text-align: center; color: #999; font-style: italic; font-family: serif; font-weight: bold; border-right: 1px solid #e1e1e1; margin-right: 5px; cursor: default; }

/* æ–°å¢ï¼šç›®æ ‡è¯æ±‡/å­—æ•°æ˜¾ç¤ºåŒº */
.target-display { min-width: 150px; height: 100%; display: flex; align-items: center; padding: 0 10px; color: #333; font-weight: bold; font-size: 14px; background: #f9f9f9; border-right: 1px solid #d4d4d4; margin-right: 5px; }

.formula-input { flex: 1; height: 100%; border: 1px solid #d4d4d4; padding: 0 5px; font-family: 'Calibri', sans-serif; font-size: 14px; outline: none; }
.formula-input:focus { border-color: #217346; }

/* ä¸»è¡¨æ ¼åŒºåŸŸ */
.spreadsheet { display: flex; height: calc(100% - 140px); position: relative; }

/* è¡Œå·åˆ—å· */
.row-headers { width: 40px; background: #f8f9fa; border-right: 1px solid #d4d4d4; display: flex; flex-direction: column; text-align: center; color: #666; padding-top: 25px; }
.row-header { height: 25px; line-height: 25px; border-bottom: 1px solid #d4d4d4; font-size: 11px; }

.col-headers { height: 25px; background: #f8f9fa; border-bottom: 1px solid #d4d4d4; display: flex; padding-left: 40px; color: #666; font-size: 11px; position: absolute; top: 0; width: 100%; z-index: 1; }
.col-header { flex: 1; border-right: 1px solid #d4d4d4; display: flex; align-items: center; justify-content: center; }

/* æ ¸å¿ƒå†…å®¹åŒº */
.grid-content { flex: 1; display: flex; margin-top: 25px; overflow: hidden; }

/* å·¦ä¾§ï¼šç©å®¶åˆ—è¡¨ (ä¼ªè£…æˆæ•°æ®åˆ—) */
.col-a { width: 180px; border-right: 1px solid #d4d4d4; display: flex; flex-direction: column; }
.cell-item { height: 25px; border-bottom: 1px solid #e1e1e1; padding: 0 5px; display: flex; align-items: center; font-size: 12px; }
.cell-item.header { font-weight: bold; background: #f0f0f0; }

/* ä¸­é—´ï¼šç”»å¸ƒ (ä¼ªè£…æˆåˆå¹¶å•å…ƒæ ¼) */
.col-b { flex: 2; border-right: 1px solid #d4d4d4; position: relative; background: #fff; padding: 2px; }
#canvas-wrapper { width: 100%; height: 100%; border: 2px solid #217346; position: relative; cursor: crosshair; }
canvas { display: block; }

/* å³ä¾§ï¼šèŠå¤©è®°å½• (ä¼ªè£…æˆå¤‡æ³¨åˆ—) */
.col-c { width: 250px; display: flex; flex-direction: column; background: #fff; border-right: 1px solid #d4d4d4; }
#messages { flex: 1; overflow-y: auto; overflow-x: hidden; }
.msg-row { min-height: 25px; border-bottom: 1px dotted #eee; padding: 2px 5px; font-size: 12px; display: flex; align-items: center; }
.msg-row.sys { color: #888; font-style: italic; }
.msg-row.win { color: #217346; font-weight: bold; background: #e6f4ea; }
.msg-row b { margin-right: 5px; color: #2b579a; }

/* åº•éƒ¨ Sheet æ ‡ç­¾ */
.footer-tabs { height: 30px; background: #f3f2f1; border-top: 1px solid #d4d4d4; display: flex; align-items: flex-end; padding-left: 10px; }
.sheet-tab { padding: 3px 15px; background: #fff; border: 1px solid #d4d4d4; border-bottom: none; color: #217346; font-weight: bold; font-size: 12px; margin-right: 5px; border-radius: 3px 3px 0 0; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
.status-bar { flex: 1; text-align: right; padding-right: 10px; color: #666; font-size: 11px; line-height: 25px; }

/* --- å¼¹çª— (ä¼ªè£…æˆ Excel è­¦å‘Šæ¡†) --- */
.modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.2); z-index: 999; justify-content: center; align-items: center; }
.excel-dialog { background: #fff; border: 1px solid #888; box-shadow: 2px 2px 10px rgba(0,0,0,0.2); width: 350px; padding: 0; font-family: 'Segoe UI', sans-serif; }
.dialog-header { background: #fff; padding: 8px 10px; display: flex; justify-content: space-between; align-items: center; font-size: 14px; }
.dialog-body { padding: 20px; background: #fff; font-size: 13px; }
.dialog-footer { padding: 10px; background: #f0f0f0; text-align: right; border-top: 1px solid #dfdfdf; }

.dialog-btn { padding: 4px 20px; border: 1px solid #adadad; background: #e1e1e1; font-size: 12px; cursor: pointer; min-width: 70px; }
.dialog-btn:hover { background: #e5f1fb; border-color: #0078d7; }
.dialog-input { width: 100%; padding: 4px; border: 1px solid #888; margin-bottom: 10px; font-family: 'Calibri'; }
.dialog-label { display: block; margin-bottom: 5px; color: #444; }

/* æ¸¸æˆçŠ¶æ€é®ç½© (ä½è°ƒç‰ˆ) */
#status-overlay { position: absolute; top: 0; left: 0; width: 100%; height: 100%; display: none; pointer-events: none; z-index: 10; }
#blocker { position: absolute; top: 0; left: 0; width: 100%; height: 100%; background: #fff; display: none; } /* çº¯ç™½é®æŒ¡ */
.overlay-text { position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); background: #fff; border: 1px solid #217346; padding: 10px 20px; text-align: center; box-shadow: 0 2px 5px rgba(0,0,0,0.1); }

/* ç”»å»Šæ¨¡å¼ */
#gallery-view { display: none; width: 100%; height: 100%; flex-wrap: wrap; overflow-y: auto; align-content: flex-start; padding: 10px; background: #f8f9fa; }
.gallery-item { width: 120px; height: 120px; border: 1px solid #ccc; margin: 5px; background: #fff; display: flex; flex-direction: column; position: relative; cursor: pointer; transition: transform 0.1s; }
.gallery-item:hover { transform: scale(1.05); border-color: #217346; box-shadow: 0 2px 5px rgba(0,0,0,0.2); }
.gallery-item img { width: 100%; height: 90px; object-fit: contain; border-bottom: 1px solid #eee; }
.gallery-item .answer { height: 30px; display: flex; align-items: center; justify-content: center; font-size: 12px; color: #666; background: #f9f9f9; }
.gallery-item.solved .answer { color: #217346; font-weight: bold; background: #e6f4ea; }

/* å›¾ç‰‡æŸ¥çœ‹å™¨ */
#image-viewer { background: rgba(0,0,0,0.8); z-index: 10000; }
#image-viewer img { max-width: 90%; max-height: 85vh; border: 4px solid #fff; box-shadow: 0 0 20px rgba(0,0,0,0.5); background: #fff; }
</style>
</head>
<body>

<!-- é¡¶éƒ¨ç»¿æ¡ -->
<div class="excel-header">
<span>æ–‡ä»¶</span>
<span>å¼€å§‹</span>
<span>æ’å…¥</span>
<span>é¡µé¢å¸ƒå±€</span>
<span>å…¬å¼</span>
<span>æ•°æ®</span>
<span>å®¡é˜…</span>
<span>è§†å›¾</span>
<span style="margin-left: auto; font-size: 12px;">ç™»å½•</span>
</div>

<!-- å·¥å…·æ  -->
<div class="ribbon">
<div class="ribbon-btn" onclick="document.getElementById('conn-panel').style.display='flex'">
<div class="ribbon-icon">ğŸ”—</div>
<div class="ribbon-text">æ•°æ®è¿æ¥</div>
</div>
<div class="ribbon-btn" id="btn-clear" onclick="clearCanvas()">
<div class="ribbon-icon">ğŸ§¹</div>
<div class="ribbon-text">æ¸…é™¤å†…å®¹</div>
</div>
<div class="ribbon-btn" onclick="resizeCanvas()">
<div class="ribbon-icon">ğŸ”„</div>
<div class="ribbon-text">åˆ·æ–°è§†å›¾</div>
</div>
<!-- ä»…æˆ¿ä¸»å¯è§çš„æŒ‰é’®ä¼šåŠ¨æ€æ§åˆ¶æ˜¾ç¤º -->
<div class="ribbon-btn" id="host-btn" style="display:none; border: 1px solid #217346; background: #e6f4ea;" onclick="document.getElementById('host-input-modal').style.display='flex'">
<div class="ribbon-icon">â–¶ï¸</div>
<div class="ribbon-text">å¼€å§‹è®¡ç®—</div>
</div>
</div>

<!-- å…¬å¼æ  (èŠå¤©è¾“å…¥) -->
<div class="formula-bar">
<div class="name-box" id="timer-display">C5</div>
<div class="fx-icon">fx</div>
<!-- æ–°å¢ï¼šæ˜¾ç¤ºè¯æ±‡æˆ–å­—æ•°æç¤º -->
<div class="target-display" id="target-word-display">ç­‰å¾…æ•°æ®...</div>
<input type="text" class="formula-input" id="msg-input" placeholder="åœ¨æ­¤è¾“å…¥æ•°æ® (æŒ‰å›è½¦å‘é€)..." onkeypress="if(event.keyCode===13) sendChat()">
</div>

<!-- ä¸»è¡¨æ ¼ -->
<div class="spreadsheet">
<!-- åˆ—å¤´ (A, B, C...) -->
<div class="col-headers">
<div class="col-header" style="width: 180px; flex: none;">A (èŒå‘˜è¡¨)</div>
<div class="col-header" style="flex: 2;">B (ç»˜å›¾åŒº)</div>
<div class="col-header" style="width: 250px; flex: none;">C (æ—¥å¿—)</div>
</div>

<!-- è¡Œå¤´ (1, 2, 3...) -->
<div class="row-headers">
<script>for(let i=1;i<30;i++) document.write(`<div class="row-header">${i}</div>`);</script>
</div>

<!-- å†…å®¹ç½‘æ ¼ -->
<div class="grid-content">
<!-- ç©å®¶åˆ—è¡¨ -->
<div class="col-a" id="p-list-content">
<div class="cell-item header">ID</div>
<div class="cell-item" style="color:#999">ç­‰å¾…æ•°æ®...</div>
</div>

<!-- ç”»å¸ƒåŒºåŸŸ -->
<div class="col-b">
<div id="canvas-wrapper">
<canvas id="canvas"></canvas>

<!-- æ¸¸æˆçŠ¶æ€é®ç½© -->
<div id="status-overlay">
<div id="blocker"></div> <!-- çº¯ç™½é®æŒ¡ï¼Œé˜²æ­¢çœ‹åˆ°ç”» -->
<div class="overlay-text">
<div id="overlay-text" style="font-size: 14px; color: #333;">å‡†å¤‡å°±ç»ª</div>
</div>
</div>

<!-- ç”»å»Š (ç»“ç®—ç•Œé¢) -->
<div id="gallery-view"></div>
</div>
</div>

<!-- èŠå¤©è®°å½• -->
<div class="col-c" id="messages">
<div class="msg-row sys">ç³»ç»Ÿ: æ¬¢è¿ä½¿ç”¨ Excel 2024ã€‚</div>
</div>
</div>
</div>

<!-- åº•éƒ¨çŠ¶æ€æ  -->
<div class="footer-tabs">
<div class="sheet-tab">Sheet1</div>
<div class="sheet-tab" style="background: #e1e1e1; color: #666; border-bottom: 1px solid #d4d4d4;">Sheet2</div>
<div class="sheet-tab" style="background: #e1e1e1; color: #666; border-bottom: 1px solid #d4d4d4;">+</div>
<div class="status-bar" id="connection-status">å°±ç»ª</div>
<div class="status-bar" id="my-role-display" style="width: auto; margin-left: 20px;">æœªè¿æ¥</div>
</div>

<!-- å¼¹çª—ï¼šè¿æ¥è®¾ç½® -->
<div id="conn-panel" class="modal" style="display: flex;">
<div class="excel-dialog">
<div class="dialog-header">
<span>è¿æ¥åˆ°å¤–éƒ¨æ•°æ®æº</span>
<span style="cursor:pointer" onclick="document.getElementById('conn-panel').style.display='none'">âœ•</span>
</div>
<div class="dialog-body">
<label class="dialog-label">ç”¨æˆ·å (User ID):</label>
<input type="text" id="nickname" class="dialog-input" value="Employee_01">

<label class="dialog-label">æœåŠ¡å™¨åœ°å€ (Room ID):</label>
<input type="text" id="room-id-input" class="dialog-input" placeholder="ä¾‹å¦‚: 1001">

<label class="dialog-label">è§’è‰²è¯·æ±‚ (Role):</label>
<select id="role-select" class="dialog-input">
<option value="OBS">è§‚ä¼— (Observer)</option>
<option value="P2">ç»˜å›¾å‘˜ (P2)</option>
<option value="P3">å®¡æ ¸å‘˜ (P3)</option>
</select>

<div style="margin-top: 15px; border-top: 1px solid #eee; padding-top: 10px;">
<span style="font-size: 11px; color: #666;">æ“ä½œ:</span>
<div style="display: flex; gap: 10px; margin-top: 5px;">
<button class="dialog-btn" onclick="createRoom()">æ–°å»ºè¿æ¥ (æˆ¿ä¸»)</button>
<button class="dialog-btn" onclick="joinRoom()">è¿æ¥ç°æœ‰ (åŠ å…¥)</button>
</div>
</div>
</div>
</div>
</div>

<!-- å¼¹çª—ï¼šæˆ¿ä¸»å‡ºé¢˜ -->
<div id="host-input-modal" class="modal">
<div class="excel-dialog">
<div class="dialog-header">
<span>è¾“å…¥å‚æ•° (é¢˜ç›®è®¾ç½®)</span>
</div>
<div class="dialog-body">
<p style="margin: 0 0 10px 0; color: #666;">è¯·è¾“å…¥5ä¸ªå¾…å¤„ç†çš„æ•°æ®é¡¹ï¼š</p>
<input type="text" id="word1" class="dialog-input" placeholder="æ•°æ®é¡¹ 1">
<input type="text" id="word2" class="dialog-input" placeholder="æ•°æ®é¡¹ 2">
<input type="text" id="word3" class="dialog-input" placeholder="æ•°æ®é¡¹ 3">
<input type="text" id="word4" class="dialog-input" placeholder="æ•°æ®é¡¹ 4">
<input type="text" id="word5" class="dialog-input" placeholder="æ•°æ®é¡¹ 5">
</div>
<div class="dialog-footer">
<button class="dialog-btn" onclick="submitWords()">ç¡®å®š</button>
</div>
</div>
</div>

<!-- æ–°å¢ï¼šå›¾ç‰‡æŸ¥çœ‹å™¨ -->
<div id="image-viewer" class="modal" onclick="this.style.display='none'">
<div style="display:flex; flex-direction:column; align-items:center;">
<img id="zoomed-img" src="">
<div style="color:white; margin-top:10px; font-size:14px; background:rgba(0,0,0,0.5); padding:5px 10px; border-radius:4px;">ç‚¹å‡»ä»»æ„å¤„å…³é—­</div>
</div>
</div>
<script>
// --- æ¸¸æˆé…ç½® ---
const DRAW_TIME = 10; // ç»˜ç”»æ—¶é—´ (ç§’)
const PREPARE_TIME = 2; // å‡†å¤‡æ—¶é—´ (ç§’)

// --- çŠ¶æ€å˜é‡ ---
let peer = null;
let myId = null;
let myName = "Employee";
let myRoleTag = "OBS";
let isHost = false;
let connections = [];
let hostConn = null;

let players = [];
let gameWords = [];
let savedImages = [];
let currentWordIndex = 0;
let timerInterval = null;
let isGameRunning = false;
let isGalleryPhase = false;
let solvedIndices = [];

const canvas = document.getElementById('canvas');
const ctx = canvas.getContext('2d');
let isDrawing = false;

// --- åˆå§‹åŒ–ç”»å¸ƒå°ºå¯¸ ---
function resizeCanvas() {
const wrapper = document.getElementById('canvas-wrapper');
if(wrapper) {
canvas.width = wrapper.clientWidth;
canvas.height = wrapper.clientHeight;
}
}
window.addEventListener('resize', resizeCanvas);
// ç¨å¾®å»¶è¿Ÿä»¥ç¡®ä¿DOMå®Œå…¨åŠ è½½
setTimeout(resizeCanvas, 500);

// --- è¾…åŠ©å‡½æ•° ---
function getP2() { return players.find(p => p.roleTag === 'P2'); }
function hasP3() { return players.some(p => p.roleTag === 'P3'); }
function setStatus(text) { document.getElementById('connection-status').innerHTML = text; }

// --- 1. ç½‘ç»œè¿æ¥ ---
function initPeer(customId) {
const peerConfig = {
debug: 1,
config: { 'iceServers': [{ url: 'stun:stun.l.google.com:19302' }] }
};
peer = customId ? new Peer(customId, peerConfig) : new Peer(null, peerConfig);

peer.on('open', id => {
myId = id;
document.getElementById('conn-panel').style.display = 'none';
document.getElementById('my-role-display').innerHTML = `ç”¨æˆ·: <b>${myName}</b> | ç«¯å£: ${id}`;
addMsg('ç³»ç»Ÿ', `âœ… è¿æ¥æˆåŠŸã€‚ç«¯å£å·ï¼š${id}`, true);
if(isHost) document.getElementById('host-btn').style.display = 'flex';
resizeCanvas();
});

peer.on('error', err => {
console.error(err);
setStatus(`<span style="color:red">é”™è¯¯: ${err.type}</span>`);
});

peer.on('disconnected', () => {
addMsg('ç³»ç»Ÿ', 'âš ï¸ è¿æ¥ä¸­æ–­ï¼Œæ­£åœ¨é‡è¯•...', true);
peer.reconnect();
});
}

function keepAlive(conn) {
const pingInterval = setInterval(() => {
if (conn && conn.open) conn.send({ type: 'ping' });
else clearInterval(pingInterval);
}, 5000);
}

function createRoom() {
const roomId = document.getElementById('room-id-input').value.trim();
if(!roomId) return alert("è¯·è¾“å…¥ç«¯å£å·(æˆ¿é—´å·)ï¼");

myName = document.getElementById('nickname').value + " (Admin)";
isHost = true;
myRoleTag = 'P1';

setStatus('æ­£åœ¨åˆå§‹åŒ–...');
initPeer(roomId);

players = [{ id: 'HOST', name: myName, roleName: 'ç®¡ç†å‘˜(P1)', roleTag: 'P1' }];
updateUI();

setTimeout(() => {
if(peer) {
peer.on('connection', conn => {
conn.on('open', () => {
connections.push(conn);
keepAlive(conn);
conn.on('data', data => handleHostData(data, conn));
conn.on('close', () => {
connections = connections.filter(c => c !== conn);
players = players.filter(p => p.id !== conn.peer);
broadcast({ type: 'update_players', players: players });
});
if(!isGameRunning) {
const img = canvas.toDataURL();
conn.send({type: 'sync_canvas', img: img});
}
});
});
}
}, 100);
}

function joinRoom() {
const roomId = document.getElementById('room-id-input').value.trim();
if(!roomId) return alert("è¯·è¾“å…¥ç«¯å£å·ï¼");

myName = document.getElementById('nickname').value;
const roleReq = document.getElementById('role-select').value;

isHost = false;
setStatus('æ­£åœ¨è¿æ¥...');
initPeer(null);

const checkPeerOpen = setInterval(() => {
if (peer && !peer.disconnected && !peer.destroyed && myId) {
clearInterval(checkPeerOpen);
setStatus(`æ­£åœ¨è¿æ¥ç«¯å£ ${roomId}...`);
hostConn = peer.connect(roomId);
hostConn.on('open', () => {
setStatus('<span style="color:green">å·²è¿æ¥</span>');
keepAlive(hostConn);
hostConn.send({ type: 'join', name: myName, roleReq: roleReq });
});
hostConn.on('data', handleClientData);
hostConn.on('close', () => { alert("è¿æ¥å·²æ–­å¼€"); location.reload(); });
}
}, 500);
}

// --- 2. æˆ¿ä¸»é€»è¾‘ ---
function handleHostData(data, conn) {
if (data.type === 'ping') return;

if (data.type === 'join') {
let assignedRoleName = 'è§‚å¯Ÿå‘˜';
let assignedRoleTag = 'OBS';
const isP2Taken = players.some(p => p.roleTag === 'P2');

if (data.roleReq === 'P2') {
if (!isP2Taken) { assignedRoleName = 'ç»˜å›¾å‘˜ (P2)'; assignedRoleTag = 'P2'; }
} else if (data.roleReq === 'P3') {
assignedRoleName = 'å®¡æ ¸å‘˜ (P3)'; assignedRoleTag = 'P3';
}

players = players.filter(p => p.id !== conn.peer);
players.push({ id: conn.peer, name: data.name, roleName: assignedRoleName, roleTag: assignedRoleTag });

broadcast({ type: 'update_players', players: players });
broadcast({ type: 'chat', name: 'ç³»ç»Ÿ', msg: `${data.name} å·²æ¥å…¥`, isSys: true });
conn.send({ type: 'you_are', roleTag: assignedRoleTag });

if (getP2() && hasP3() && !isGameRunning) {
document.getElementById('host-input-modal').style.display = 'flex';
}
}

// è½¬å‘ç»˜ç”»æ•°æ®
if (data.type === 'draw' || data.type === 'clear') {
const p2 = getP2();
const isSenderP2 = (p2 && conn.peer === p2.id);

if (!isGameRunning || isSenderP2) {
if(data.type === 'draw') drawLocal(data.x, data.y, data.isStart);
else ctx.clearRect(0,0,canvas.width, canvas.height);

connections.forEach(c => {
if(c.peer !== conn.peer) c.send(data);
});
}
}

if (data.type === 'chat') {
broadcast({ type: 'chat', name: data.name, msg: data.msg });
if (isGameRunning || isGalleryPhase) checkGuess(data.msg, data.name);
}
}

function submitWords() {
if(!getP2() || !hasP3()) return alert("äººå‘˜é…ç½®ä¸å®Œæ•´ (éœ€ P2, P3)");
const inputs = [1,2,3,4,5].map(i => document.getElementById('word'+i).value.trim());
if (inputs.some(w => !w)) return alert("æ•°æ®ä¸å®Œæ•´");

gameWords = inputs;
savedImages = [];
solvedIndices = [];
document.getElementById('host-input-modal').style.display = 'none';

isGameRunning = true;
isGalleryPhase = false;
currentWordIndex = -1;

broadcast({ type: 'chat', name: 'ç³»ç»Ÿ', msg: `ä»»åŠ¡å¼€å§‹`, isSys: true });
nextWord();
}

function nextWord() {
currentWordIndex++;
clearInterval(timerInterval);

if (currentWordIndex >= 5) {
startGalleryPhase();
return;
}

const word = gameWords[currentWordIndex];
let prepTime = PREPARE_TIME;
broadcastState('prepare', word, prepTime);

timerInterval = setInterval(() => {
prepTime--;
if (prepTime > 0) {
broadcastState('prepare', word, prepTime);
} else {
clearInterval(timerInterval);
startDrawingPhase(word);
}
}, 1000);
}

function startDrawingPhase(word) {
ctx.clearRect(0,0,canvas.width, canvas.height);
broadcast({ type: 'clear' }, 'HOST');

let drawTime = DRAW_TIME;
broadcastState('drawing', word, drawTime);

timerInterval = setInterval(() => {
drawTime--;
if (drawTime >= 0) {
broadcastState('drawing', word, drawTime);
} else {
clearInterval(timerInterval);
const imgData = canvas.toDataURL("image/png");
savedImages.push(imgData);
broadcast({ type: 'chat', name: 'ç³»ç»Ÿ', msg: `æ•°æ® ${currentWordIndex+1} å·²å½’æ¡£`, isSys: true });
setTimeout(nextWord, 1000);
}
}, 1000);
}

function startGalleryPhase() {
isGalleryPhase = true;
isGameRunning = false;
broadcast({ type: 'chat', name: 'ç³»ç»Ÿ', msg: 'å®¡æ ¸ç»“æŸï¼ŒæŸ¥çœ‹æ±‡æ€»', isSys: true });
// ä¿®å¤ï¼šå°† gameWords å‘é€ç»™æ‰€æœ‰å®¢æˆ·ç«¯ï¼Œä»¥ä¾¿ P2/P3 æ˜¾ç¤º
const galleryData = { type: 'show_gallery', images: savedImages, words: gameWords };
broadcast(galleryData, 'HOST');
handleClientData(galleryData);
}

function checkGuess(msg, playerName) {
gameWords.forEach((word, idx) => {
if (solvedIndices.includes(idx)) return;
if (msg.includes(word)) {
solvedIndices.push(idx);
const winMsg = `âœ”ï¸ ${playerName} çŒœå‡ºäº†æ•°æ® ${idx+1}ï¼šã€${word}ã€‘`;
broadcast({ type: 'solve_word', index: idx, word: word, msg: winMsg });
if(isGalleryPhase) updateGalleryItem(idx, word);
addMsg('ç³»ç»Ÿ', winMsg, false, true);
}
});
}

function broadcastState(phase, word, time) {
const data = { type: 'state_update', phase: phase, time: time, word: word, index: currentWordIndex + 1 };
const wordLength = word.length;
const mask = Array(wordLength).fill("â—¯").join(" ") + ` (${wordLength}å­—)`;
updateGameUI(data); 

connections.forEach(conn => {
const p = players.find(pl => pl.id === conn.peer);
if (!p) return;
if (p.roleTag === 'P3' || p.roleTag === 'OBS') {
conn.send({...data, word: mask});
} else {
conn.send(data);
}
});
}

function broadcast(data, excludeId) {
connections.forEach(c => { if(c.peer !== excludeId) c.send(data); });
if (isHost && excludeId !== 'HOST') {
if(data.type === 'update_players') updateUI();
if(data.type === 'chat') addMsg(data.name, data.msg, data.isSys, data.isWin);
}
}

// --- 3. å®¢æˆ·ç«¯é€»è¾‘ ---
function handleClientData(data) {
if (data.type === 'ping') return;
if (data.type === 'you_are') {
myRoleTag = data.roleTag;
document.getElementById('my-role-display').innerHTML += ` | è§’è‰²: <b>${data.roleTag}</b>`;
}
if (data.type === 'update_players') { players = data.players; updateUI(); }
if (data.type === 'chat') addMsg(data.name, data.msg, data.isSys, data.isWin);
if (data.type === 'draw') drawLocal(data.x, data.y, data.isStart);
if (data.type === 'clear') ctx.clearRect(0,0,canvas.width, canvas.height);
if (data.type === 'state_update') updateGameUI(data);

// ä¿®å¤ï¼šæ¥æ”¶å¹¶åŒæ­¥é¢˜ç›®æ•°æ®
if (data.type === 'show_gallery') {
    if(data.words) gameWords = data.words; 
    renderGallery(data.images);
}

if (data.type === 'solve_word') {
if(isGalleryPhase) updateGalleryItem(data.index, data.word);
addMsg('ç³»ç»Ÿ', data.msg, false, true);
}
if (data.type === 'sync_canvas') {
const img = new Image();
img.onload = () => ctx.drawImage(img, 0, 0);
img.src = data.img;
}
}

// --- 4. UI æ›´æ–° ---
function renderGallery(images) {
  document.getElementById('canvas-wrapper').style.border = 'none';
  document.getElementById('canvas').style.display = 'none';
  document.getElementById('status-overlay').style.display = 'none';
  document.getElementById('target-word-display').innerText = "æ±‡æ€»é˜¶æ®µ";

  const gView = document.getElementById('gallery-view');
  gView.style.display = 'flex';
  
  gView.innerHTML = images.map((src, i) => {
    // ä¿®å¤ï¼šè·å–é¢˜ç›®æ–‡å­—å’Œé•¿åº¦
    const word = gameWords[i] || "";
    const wordLen = word.length;
    
    // ä¿®å¤ï¼šåˆ¤æ–­è°æœ‰æƒé™çœ‹ç­”æ¡ˆ
    // P1(æˆ¿ä¸») æˆ– P2(ç»˜å›¾å‘˜) æˆ– å·²ç»çŒœå‡ºæ¥çš„é¢˜ç›® -> æ˜¾ç¤ºç­”æ¡ˆ
    const canSeeAnswer = (myRoleTag === 'P1' || myRoleTag === 'P2' || solvedIndices.includes(i));
    
    let displayText;
    if (canSeeAnswer) {
        // P2 åœ¨è¿™é‡Œå¯ä»¥çœ‹åˆ°å®Œæ•´åå­—
        displayText = word;
    } else {
        // P3 (å®¡æ ¸å‘˜) æˆ–å…¶ä»–æ²¡çŒœå‡ºæ¥çš„äºº -> æ˜¾ç¤ºå­—æ•°æç¤º
        displayText = `<span style="color:#888; font-style:italic;">( ${wordLen} ä¸ªå­— )</span>`;
    }

    return `
    <div class="gallery-item" id="g-item-${i}" onclick="viewImage('${src}')" title="ç‚¹å‡»æ”¾å¤§">
    <img src="${src}">
    <div class="answer" id="ans-${i}">
      ${displayText}
    </div>
    </div>
    `;
  }).join('');
}

function viewImage(src) {
document.getElementById('zoomed-img').src = src;
document.getElementById('image-viewer').style.display = 'flex';
}

function updateGalleryItem(index, word) {
const item = document.getElementById(`g-item-${index}`);
const ans = document.getElementById(`ans-${index}`);
if(item && ans) { item.classList.add('solved'); ans.innerText = word; }
}

function updateUI() {
const html = players.map(p => `
<div class="cell-item">
<span style="width:20px; text-align:center; color:#999; margin-right:5px;">${p.roleTag}</span>
<span>${p.name}</span>
</div>
`).join('');
document.getElementById('p-list-content').innerHTML = `<div class="cell-item header">ID</div>` + html;

const btnClear = document.getElementById('btn-clear');
if (!isGameRunning) btnClear.disabled = false;
else btnClear.disabled = (myRoleTag !== 'P2');
}

function updateGameUI(data) {
document.getElementById('canvas').style.display = 'block';
document.getElementById('gallery-view').style.display = 'none';
document.getElementById('canvas-wrapper').style.border = '2px solid #217346';

const overlay = document.getElementById('status-overlay');
const text = document.getElementById('overlay-text');
const timer = document.getElementById('timer-display');
const blocker = document.getElementById('blocker');
const wordDisplay = document.getElementById('target-word-display');

overlay.style.display = 'block';
timer.innerText = data.time + 's';
wordDisplay.innerText = data.word;

if (data.phase === 'prepare') {
text.innerHTML = `æ•°æ®é¡¹ ${data.index}/5 <br>å‡†å¤‡: <span style="font-weight:bold">${data.word}</span>`;
blocker.style.display = 'block';
} else if (data.phase === 'drawing') {
blocker.style.display = 'none';
overlay.style.display = 'none';
timer.style.color = 'red';
}
}

function addMsg(name, msg, isSys, isWin) {
const div = document.createElement('div');
div.className = `msg-row ${isSys?'sys':''} ${isWin?'win':''}`;
div.innerHTML = (isSys||isWin) ? msg : `<b>${name}:</b> ${msg}`;
const box = document.getElementById('messages');
box.appendChild(div);
box.scrollTop = box.scrollHeight;
}

function sendChat() {
const input = document.getElementById('msg-input');
const val = input.value.trim();
if(!val) return;
if (isHost) {
broadcast({ type: 'chat', name: myName, msg: val });
if(isGameRunning || isGalleryPhase) checkGuess(val, myName);
addMsg(myName, val);
} else {
if(hostConn && hostConn.open) hostConn.send({ type: 'chat', msg: val, name: myName });
}
input.value = '';
}

// --- 5. ç”»æ¿é€»è¾‘ ---
function getPos(e) {
const rect = canvas.getBoundingClientRect();
const t = e.changedTouches ? e.changedTouches[0] : e;
return {
x: (t.clientX - rect.left) / canvas.width,
y: (t.clientY - rect.top) / canvas.height
};
}

function startDraw(e) {
const canDraw = (!isGameRunning) || (isGameRunning && myRoleTag === 'P2');
if (!isDrawing && canDraw) {
isDrawing = true;
const p = getPos(e);
drawLocal(p.x, p.y, true);

const drawData = { type: 'draw', x: p.x, y: p.y, isStart: true };
if(!isHost) hostConn.send(drawData);
else broadcast(drawData, 'HOST');
}
}

function moveDraw(e) {
if (!isDrawing) return;
e.preventDefault();
const p = getPos(e);
drawLocal(p.x, p.y, false);

const drawData = { type: 'draw', x: p.x, y: p.y, isStart: false };
if(!isHost) hostConn.send(drawData);
else broadcast(drawData, 'HOST');
}

function stopDraw() { isDrawing = false; }

function drawLocal(x, y, isStart) {
const actualX = x * canvas.width;
const actualY = y * canvas.height;
ctx.lineWidth = 2;
ctx.lineCap = 'round';
ctx.strokeStyle = '#000';
if (isStart) { ctx.beginPath(); ctx.moveTo(actualX, actualY); }
else { ctx.lineTo(actualX, actualY); ctx.stroke(); }
}

function clearCanvas() {
if (!isGameRunning || myRoleTag === 'P2') {
ctx.clearRect(0,0,canvas.width, canvas.height);
const data = { type: 'clear' };
if(!isHost) hostConn.send(data);
else broadcast(data, 'HOST');
}
}

canvas.addEventListener('mousedown', startDraw);
canvas.addEventListener('mousemove', moveDraw);
canvas.addEventListener('mouseup', stopDraw);
canvas.addEventListener('mouseout', stopDraw);
canvas.addEventListener('touchstart', startDraw, {passive: false});
canvas.addEventListener('touchmove', moveDraw, {passive: false});
canvas.addEventListener('touchend', stopDraw);
</script>
</body>
</html>

